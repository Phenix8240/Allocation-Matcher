{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Status Modal -->
    <div id="status-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="mx-auto mb-4">
                    {% if electives_saved %}
                        <svg class="w-12 h-12 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    {% else %}
                        <svg class="w-12 h-12 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    {% endif %}
                </div>
                <h3 class="text-lg font-medium mb-2">
                    {% if electives_saved %}
                        Electives Submitted!
                    {% else %}
                        Electives Pending
                    {% endif %}
                </h3>
                <p class="text-gray-600 mb-4">
                    {% if electives_saved %}
                        Your elective selections have been successfully submitted.
                    {% else %}
                        Please submit your elective choices before the deadline.
                    {% endif %}
                </p>
                <button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Continue
                </button>
            </div>
        </div>
    </div>
    <!-- Sidebar (Fixed) -->
    <div class="fixed top-0 left-0 w-64 h-screen bg-gradient-to-b from-blue-600 to-blue-800 text-white flex flex-col">
        <div class="p-4 text-xl font-bold">Student Portal</div>
        <nav class="flex-1 overflow-y-auto">
            {% if not electives_saved %}
                <a href="#" id="dashboard-link" class="flex items-center p-4 hover:bg-blue-700 rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Dashboard
                </a>
            {% endif %}
            <a href="#" id="core-subjects-link" class="flex items-center p-4 hover:bg-blue-700 rounded-lg">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                Core Subjects
            </a>
            <a href="#" id="electives-link" class="flex items-center p-4 hover:bg-blue-700 rounded-lg">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Choose Electives
            </a>
        </nav>
        <a href="{% url 'logout' %}" class="p-4 hover:bg-blue-700 rounded-lg flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            Logout
        </a>
    </div>

    <!-- Header (Fixed) -->
    <header class="fixed top-2 left-[264px] right-2  h-[94px] bg-white shadow flex justify-between items-center px-4 border-b border-gray-200 rounded-lg">
        <div>
            <h1 class="text-xl font-bold text-blue-700">
                Welcome, <span id="welcome-name"></span>
            </h1>
            {% if student.roll %}
                <p class="text-sm text-gray-600">Roll: {{ student.roll }}</p>
            {% endif %}
        </div>
        <!-- Add this updated right-side section -->
        <div class="text-right">
            <p class="text-gray-800">{{ student.user.email }}</p>
            <p class="text-sm text-gray-600">{{ student.get_department_display }} | Semester {{ student.semester }}</p>
        </div>
    </header>

    <!-- Main Content (Scrollable) -->
    <main class="ml-64 mt-16 p-6 bg-gray-50 mt-[95px]" style="height: calc(100vh - 4rem); overflow-y: auto;">

        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="p-2 {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %} rounded">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <div id="content-area" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-blue-600">Dashboard</h2>
            <p class="text-gray-700">Welcome to your student portal. Use the sidebar to view core subjects or choose electives.</p>
        </div>
        <!-- Core Subjects Section -->
        <div id="core-subjects-section" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-blue-600">Core Subjects</h2>
            <div id="core-subjects-list" class="grid grid-cols-1 gap-4"></div>
        </div>
        <!-- Electives Section -->
        <div id="electives-panel" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-blue-600">Electives</h2>
            <div id="electives-content" class="space-y-4"></div>
        </div>
    </main>

    <script>
        // CSRF Token Handling
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    
        // Auto-show modal after 1 second
        setTimeout(() => {
            if(!sessionStorage.getItem('modalClosed')) {
                document.getElementById('status-modal').classList.remove('hidden');
            }
        }, 1000);
    
        function closeModal() {
            document.getElementById('status-modal').classList.add('hidden');
            sessionStorage.setItem('modalClosed', 'true');
        }
    
        $(document).ready(function() {
            // Extract and display the name in the welcome message
            const email = '{{ student.user.email }}';
            const name = email.split('@')[0].split('.')[1];
            const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
            $('#welcome-name').text(capitalizedName);
    
            // Function to show core subjects
            function showCoreSubjects() {
                $.get('{% url 'fetch_core_subjects' %}', function(data) {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    let html = '';
                    data.core_subjects.forEach(subject => {
                        html += `
                            <div class="p-4 bg-white shadow-md rounded-lg">
                                <h3 class="font-bold text-gray-800">${subject.code}</h3>
                                <p class="text-gray-700">${subject.name}</p>
                                <p class="text-sm text-gray-500">${subject.stream === "Core CS" ? "Theory" : "Labratory"} Subject</p>
                            </div>
                        `;
                    });
                    $('#core-subjects-list').html(html);
                });
            }
    
            // Function to show electives
            function showElectives(mode = '') {
                $.get('{% url 'fetch_electives' %}?mode=' + mode, function(data) {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    let html = '';
                    if (data.chosen) {
                        html += '<h3 class="font-bold mb-2 text-gray-800">Chosen Electives</h3>';
                        data.chosen.forEach(subject => {
                            html += `
                                <div class="p-4 bg-white shadow-md rounded-lg">
                                    <h4 class="font-bold text-gray-800">${subject.code}</h4>
                                    <p class="text-gray-700">${subject.name}</p>
                                    <p class="text-sm text-gray-500">Stream: ${subject.stream}</p>
                                </div>
                            `;
                        });
                        html += '<button id="edit-electives" class="mt-4 bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Edit Choices</button>';
                    } else {
                        html += '<h3 class="font-bold mb-2 text-gray-800">Choose Electives</h3>';
                        for (let stream in data.electives) {
                            html += `<div class="mb-4"><h4 class="font-semibold text-gray-700">${stream}</h4>`;
                            data.electives[stream].forEach(subject => {
                                let checked = data.selected.includes(subject.code) ? 'checked' : '';
                                html += `
                                    <div class="flex items-center">
                                        <input type="checkbox" class="elective-checkbox mr-2" value="${subject.code}" ${checked}>
                                        <label class="text-gray-700">${subject.code}: ${subject.name}</label>
                                    </div>
                                `;
                            });
                            html += '</div>';
                        }
                        html += '<button id="save-electives" class="mt-4 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Save Selections</button>';
                    }
                    $('#electives-content').html(html);
                });
            }
    
            // Sidebar link handlers
            $('#dashboard-link').click(function(e) {
                e.preventDefault();
                $('#core-subjects-section, #electives-panel').addClass('hidden');
                $('#content-area').removeClass('hidden');
            });
    
            $('#core-subjects-link').click(function(e) {
                e.preventDefault();
                $('#content-area, #electives-panel').addClass('hidden');
                $('#core-subjects-section').removeClass('hidden');
                showCoreSubjects();
            });
    
            $('#electives-link').click(function(e) {
                e.preventDefault();
                $('#content-area, #core-subjects-section').addClass('hidden');
                $('#electives-panel').removeClass('hidden');
                showElectives();
            });
    
            // Handle save electives with confirmation
            $(document).on('click', '#save-electives', function() {
                if (confirm("Are you sure you want to save your elective choices?")) {
                    const csrftoken = getCookie('csrftoken');
                    let selected_codes = $('.elective-checkbox:checked').map(function() {
                        return this.value;
                    }).get();
                    
                    $.ajax({
                        url: '{% url 'save_elective_selection' %}',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ 
                            selected_codes: selected_codes,
                            csrfmiddlewaretoken: csrftoken  // Additional security
                        }),
                        headers: { 
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json'
                        },
                        success: function(response) {
                            alert(response.message);
                            window.location.reload();
                        },
                        error: function(xhr) {
                            alert(xhr.responseJSON.error);
                        }
                    });
                }
            });
    
            // Handle edit electives
            $(document).on('click', '#edit-electives', function() {
                showElectives('edit');
            });
    
            // Show core subjects by default
            $('#core-subjects-link').click();
        });
        // Auto-show modal after 1 second
        setTimeout(() => {
            if (!sessionStorage.getItem('modalClosed')) {
                const modal = document.getElementById('status-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex'); // Add flex display
                }
            }
        }, 1000);

        function closeModal() {
            const modal = document.getElementById('status-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                sessionStorage.setItem('modalClosed', 'true');
            }
        }
    </script>
</body>
</html>