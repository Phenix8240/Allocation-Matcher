{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elective Comparison Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8f9fa;
      --text: #212529;
      --navbar-bg: #ffffff;
      --navbar-text: #212529;
      --card-bg: #ffffff;
      --header-bg: #343a40;
      --header-text: #ffffff;
      --border-color: #dee2e6;
      --hover-bg: #f1f1f1;
      --match: #28a745;
      --mismatch: #dc3545;
      --pending: #ffc107;
    }

    .dark-mode {
      --bg: #181818;
      --text: #e0e0e0;
      --navbar-bg: #121212;
      --navbar-text: #ffffff;
      --card-bg: #242424;
      --header-bg: #333;
      --header-text: #ffffff;
      --border-color: #444;
      --hover-bg: #2d2d2d;
      --match: #71dd8a;
      --mismatch: #ff6b6b;
      --pending: #ffca2c;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      padding-top: 70px;
      transition: all 0.3s ease;
    }

    .navbar {
      background-color: var(--navbar-bg);
      color: var(--navbar-text);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .navbar-brand,
    .theme-toggle {
      color: var(--navbar-text) !important;
    }

    .container {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    h1 {
      font-weight: bold;
      text-align: center;
      margin-bottom: 2rem;
    }

    .search-bar input {
      border-radius: 2rem;
      padding: 0.75rem 1.25rem;
    }

    .table-responsive {
      overflow: auto;
      border-radius: 12px;
      position: relative;
    }

    table.table-custom {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      table-layout: fixed;
      color: var(--text);
    }

    .table-custom thead th {
      background-color: var(--header-bg) !important;
      color: var(--header-text) !important;
      text-transform: uppercase;
      padding: 0.75rem 2rem;
    }

    .table-custom tbody td, .table-custom th {
      color: var(--text);
    }

    .table-custom tbody td {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      vertical-align: middle;
      text-align: left;
      white-space: pre-wrap;
    }

    .table-custom tbody tr:hover {
      background-color: var(--hover-bg);
    }

    .table-custom th:first-child {
      border-top-left-radius: 12px;
    }

    .table-custom th:last-child {
      border-top-right-radius: 12px;
    }

    .match {
      color: var(--match) !important;
      font-weight: 600;
    }

    .mismatch {
      color: var(--mismatch) !important;
      font-weight: 600;
    }

    .pending {
      color: var(--pending) !important;
      font-weight: 600;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      margin-left: auto;
      cursor: pointer;
    }

    .roll-no-cell {
      vertical-align: middle;
      text-align: center;
    }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .btn-download {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .btn-download:hover {
      background-color: #0b5ed7;
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      th, td {
        font-size: 0.9rem;
      }
      .action-buttons {
        flex-direction: column;
        gap: 1rem;
      }
    }

    /* Print-specific styles */
    @media print {
      body {
        padding-top: 0;
        background-color: white !important;
        color: black !important;
      }
      .navbar, .theme-toggle, .search-bar, .btn-download {
        display: none !important;
      }
      .container {
        box-shadow: none;
        padding: 0;
        border-radius: 0;
      }
      .table-responsive {
        overflow: visible;
      }
      .table-custom {
        page-break-inside: auto;
      }
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg fixed-top px-4">
    <a class="navbar-brand fw-bold" href="#">Elective Comparator</a>
    <button id="themeToggle" class="theme-toggle" title="Toggle Theme">
      <i class="fas fa-moon"></i>
    </button>
  </nav>

  <div class="container mt-5">
    <h1>Comparison Results</h1>

    <div class="action-buttons">
      <div class="search-bar">
        <input type="text" class="form-control" id="searchRollNo" placeholder="Search by Roll No">
      </div>
      <button id="downloadPdf" class="btn-download">
        <i class="fas fa-file-pdf"></i> Download as PDF
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-custom" id="resultsTable">
        <thead>
          <tr>
            <th>Roll No</th>
            <th>Elective Category</th>
            <th>Chosen Subject</th>
            <th>Allocated Subject</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
          <tr>
            {% if result.rowspan > 0 %}
            <td rowspan="{{ result.rowspan }}" class="roll-no-cell">{{ result.Roll No }}</td>
            {% endif %}
            <td>{{ result.Elective Category }}</td>
            <td>{{ result.Chosen }}</td>
            <td>{{ result.Allocated }}</td>
            <td class="{% if result.Status == 'Match' %}match{% elif result.Status == 'Mismatch' %}mismatch{% elif result.Status in ['Not Chosen', 'Pending Allocation', 'Not Chosen/Not Allocated'] %}pending{% else %}text-muted{% endif %}">{{ result.Status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // Theme toggle functionality
    document.getElementById('themeToggle').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      const icon = this.querySelector('i');
      if (document.body.classList.contains('dark-mode')) {
        icon.classList.replace('fa-moon', 'fa-sun');
      } else {
        icon.classList.replace('fa-sun', 'fa-moon');
      }
    });

    // Search functionality
    document.getElementById('searchRollNo').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#resultsTable tbody tr');
      
      rows.forEach(row => {
        const rollNoCell = row.querySelector('.roll-no-cell');
        if (rollNoCell) {
          const rollNo = rollNoCell.textContent.toLowerCase();
          if (rollNo.includes(searchTerm)) {
            // Show this row and all its sibling rows with the same roll number
            let currentRow = row;
            while (currentRow) {
              currentRow.style.display = '';
              const nextRow = currentRow.nextElementSibling;
              if (!nextRow || !nextRow.querySelector('.roll-no-cell')) {
                currentRow = nextRow;
              } else {
                currentRow = null;
              }
            }
          } else {
            // Hide this row and all its sibling rows with the same roll number
            let currentRow = row;
            while (currentRow) {
              currentRow.style.display = 'none';
              const nextRow = currentRow.nextElementSibling;
              if (!nextRow || !nextRow.querySelector('.roll-no-cell')) {
                currentRow = nextRow;
              } else {
                currentRow = null;
              }
            }
          }
        }
      });
    });

    // PDF Download functionality - UPDATED TO CAPTURE FULL CONTENT
    document.getElementById('downloadPdf').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      
      // Create a new container for PDF content
      const pdfContainer = document.createElement('div');
      pdfContainer.className = 'pdf-container';
      pdfContainer.style.position = 'absolute';
      pdfContainer.style.left = '-9999px';
      pdfContainer.style.width = '100%';
      
      // Clone the container element with all its content
      const container = document.querySelector('.container');
      const containerClone = container.cloneNode(true);
      
      // Remove elements we don't want in the PDF
      const searchBar = containerClone.querySelector('.search-bar');
      if (searchBar) searchBar.remove();
      const downloadBtn = containerClone.querySelector('.btn-download');
      if (downloadBtn) downloadBtn.remove();
      
      // Apply PDF-specific styles
      containerClone.style.boxShadow = 'none';
      containerClone.style.padding = '20px';
      containerClone.style.width = '100%';
      
      // Force table to take full width
      const table = containerClone.querySelector('.table-custom');
      if (table) {
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
      }
      
      // Force status colors
      containerClone.querySelectorAll('.match').forEach(el => {
        el.style.color = '#28a745';
        el.style.fontWeight = '600';
      });
      containerClone.querySelectorAll('.mismatch').forEach(el => {
        el.style.color = '#dc3545';
        el.style.fontWeight = '600';
      });
      containerClone.querySelectorAll('.pending').forEach(el => {
        el.style.color = '#ffc107';
        el.style.fontWeight = '600';
      });
      
      pdfContainer.appendChild(containerClone);
      document.body.appendChild(pdfContainer);
      
      try {
        // Convert to canvas with higher quality
        const canvas = await html2canvas(pdfContainer, {
          scale: 2, // Higher resolution for better quality
          logging: false,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: 0,
          width: pdfContainer.scrollWidth,
          height: pdfContainer.scrollHeight
        });
        
        // Create PDF in portrait mode
        const pdf = new jsPDF('p', 'pt', 'a4');
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        
        // Calculate dimensions to fit page with margins
        const pageWidth = pdf.internal.pageSize.getWidth() - 40; // 20px margins on each side
        const pageHeight = (canvas.height * pageWidth) / canvas.width;
        
        // Add image to PDF with proper positioning
        let position = 20;
        let remainingHeight = pageHeight;
        let currentPage = 0;
        
        while (remainingHeight > 0) {
          if (currentPage > 0) {
            pdf.addPage();
          }
          
          const height = Math.min(remainingHeight, pdf.internal.pageSize.getHeight() - 40);
          pdf.addImage(imgData, 'JPEG', 20, position, pageWidth, height, undefined, 'FAST');
          
          position -= pdf.internal.pageSize.getHeight() - 60;
          remainingHeight -= height;
          currentPage++;
        }
        
        // Add footer with timestamp
        const now = new Date();
        pdf.setFontSize(10);
        pdf.text(`Generated on ${now.toLocaleString()}`, 20, pdf.internal.pageSize.getHeight() - 20);
        
        // Save the PDF
        pdf.save('elective_comparison_results.pdf');
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF. Please try again.');
      } finally {
        // Clean up
        document.body.removeChild(pdfContainer);
      }
    });
  </script>
</body>
</html>